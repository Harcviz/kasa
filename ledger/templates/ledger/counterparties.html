{% extends "ledger/base.html" %}
{% load money %}
{% block title %}Cariler{% endblock %}

{% block content %}
    <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-1 glass rounded-xl p-5 border border-emerald-400/20 space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-300">Yeni cari</p>
                    <h2 class="text-xl font-semibold">Cari oluştur</h2>
                </div>
            </div>
            <form method="post" class="space-y-3">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_cari">
                <label class="block text-sm space-y-1">
                    <span>Ad</span>
                    <input name="name" required class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Firma / kişi adı">
                </label>
                <label class="block text-sm space-y-1">
                    <span>İletişim</span>
                    <input name="contact" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Telefon / e-posta">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Not</span>
                    <textarea name="notes" rows="3" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Notlar"></textarea>
                </label>
                <button type="submit" class="w-full px-5 py-2 rounded-lg bg-emerald-500 text-black font-semibold hover:bg-emerald-400 transition">Ekle</button>
            </form>
            {% if message %}
                <div class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-sm" data-toast>{{ message }}</div>
            {% endif %}
            {% if error %}
                <div class="px-4 py-2 rounded-lg bg-rose-500/20 border border-rose-400/30 text-sm">{{ error }}</div>
            {% endif %}
        </div>

        <div class="md:col-span-2 glass rounded-xl p-5 border border-emerald-400/20 space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold">Cari özetleri</h2>
                <span class="text-xs text-slate-400">{{ summaries|length }} kayıt</span>
            </div>
            <div class="grid md:grid-cols-2 gap-3">
                {% for c in summaries %}
                    <div class="glass rounded-lg p-3 border border-white/10">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold">{{ c.name }}</p>
                                <p class="text-xs text-slate-400">{{ c.contact|default:"-" }}</p>
                            </div>
                            <span class="text-sm px-3 py-1 rounded-full bg-white/10 {% if c.net >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                                Net: {{ c.net|default_if_none:0|money }} ₺
                            </span>
                        </div>
                        <div class="mt-2 grid grid-cols-3 text-xs text-slate-300">
                            <div>Gelir<br><span class="text-emerald-300 text-sm font-semibold">{{ c.incoming|default_if_none:0|money }} ₺</span></div>
                            <div>Gider<br><span class="text-rose-300 text-sm font-semibold">{{ c.outgoing|default_if_none:0|money }} ₺</span></div>
                            <div>Not<br><span class="text-slate-400">{{ c.notes|default:"-" }}</span></div>
                        </div>
                        <div class="mt-3 flex items-center gap-2">
                            <button type="button" class="px-3 py-1 rounded bg-emerald-500 text-black text-xs font-semibold hover:bg-emerald-400" onclick="selectAndPrint('{{ c.id }}')">Yazdır</button>
                        </div>
                        <form method="post" class="mt-2 flex items-center gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_cari">
                            <input type="hidden" name="counterparty_id" value="{{ c.id }}">
                            <input type="text" name="audit_note" placeholder="Silme notu (isteğe bağlı)" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                            <button type="submit" class="px-3 py-1 rounded bg-rose-500 text-black text-xs font-semibold hover:bg-rose-400" data-confirm="Carinin tüm hareketleri korunur, cari silinsin mi?">Sil</button>
                        </form>
                    </div>
                {% empty %}
                    <p class="text-slate-400">Cari eklenmedi.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="glass rounded-xl p-5 border border-emerald-400/20 space-y-4 mt-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Cari için Gelir / Gider</h3>
            <span class="text-xs text-slate-400">Cari opsiyoneldir; seçilmezse genel kasa hareketi olarak eklenir.</span>
        </div>
        <form method="post" class="space-y-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_tx">
            <div class="grid md:grid-cols-4 gap-3">
                <label class="block text-sm space-y-1 md:col-span-2">
                    <span>Cari</span>
                    <select id="cp-select" name="counterparty" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                        <option value="">Cari seç (opsiyonel)</option>
                        {% for c in counterparties %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="block text-sm space-y-1">
                    <span>Hesap</span>
                    <select name="account" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                        {% for a in accounts %}
                            <option value="{{ a.value }}">{{ a.label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="block text-sm space-y-1">
                    <span>Yön</span>
                    <select name="direction" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                        {% for d in directions %}
                            <option value="{{ d.value }}">{{ d.label }}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <div class="grid md:grid-cols-3 gap-3">
                <label class="block text-sm space-y-1">
                    <span>Tutar</span>
                    <input type="number" step="0.01" name="amount" required class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="0.00">
                </label>
                <label class="block text-sm space-y-1 md:col-span-2">
                    <span>Açıklama</span>
                    <input type="text" name="description" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Örn: tahsilat, ödeme">
                </label>
            </div>
            <button type="submit" class="px-5 py-2 rounded-lg bg-emerald-500 text-black font-semibold hover:bg-emerald-400 transition">Kaydet</button>
        </form>
    </div>

    <div class="glass rounded-xl p-5 border border-emerald-400/20 space-y-4 mt-4">
        <div class="flex items-center justify-between gap-3 flex-wrap">
            <h3 class="text-lg font-semibold">Yazdır</h3>
            <div class="flex gap-2 flex-wrap items-center">
                <select id="cp-print-select" class="rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 text-sm">
                    <option value="all">Tümü</option>
                    {% for c in counterparties %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
                <select id="cp-print-orientation" class="rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 text-sm">
                    <option value="portrait">Dikey</option>
                    <option value="landscape">Yatay</option>
                </select>
                <button type="button" onclick="printCounterparties()" class="px-4 py-2 rounded-lg bg-emerald-500 text-black font-semibold hover:bg-emerald-400">Yazdır</button>
            </div>
        </div>
        <p class="text-xs text-slate-400">Cari özetlerini yazıcıdan almak için yukarıdaki butonu kullanın. İsterseniz tek bir cari seçip tarihleriyle birlikte yazdırabilirsiniz.</p>
    </div>

    <div id="cp-print-all" class="hidden">
        <h2>Genel Cari Özet</h2>
        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-top:6px;">
            <thead>
                <tr>
                    <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px;">Cari</th>
                    <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px;">İletişim</th>
                    <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px;">Gelir</th>
                    <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px;">Gider</th>
                    <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px;">Net</th>
                </tr>
            </thead>
            <tbody>
                {% for cp in cp_print_data %}
                    <tr>
                        <td style="padding:6px;border-bottom:1px solid #e5e7eb;">{{ cp.name }}</td>
                        <td style="padding:6px;border-bottom:1px solid #e5e7eb;">{{ cp.contact|default:"-" }}</td>
                        <td style="padding:6px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ cp.incoming|money }} ₺</td>
                        <td style="padding:6px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ cp.outgoing|money }} ₺</td>
                        <td style="padding:6px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ cp.net|money }} ₺</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3 style="margin-top:16px;">Aylık Özet (Cari bazlı)</h3>
        {% for cp in cp_monthly %}
            <div style="margin-top:8px;">
                <strong>{{ cp.name }}</strong>
                <table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:4px;">
                    <thead>
                        <tr>
                            <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Ay</th>
                            <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Gelir</th>
                            <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Gider</th>
                            <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Net</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in cp.months %}
                            <tr>
                                <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{{ m.name }}</td>
                                <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ m.incoming|money }} ₺</td>
                                <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ m.outgoing|money }} ₺</td>
                                <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ m.net|money }} ₺</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}

        <h3 style="margin-top:16px;">İşlem Listesi (tarihli)</h3>
        {% for item in cp_tx_map %}
            <div style="margin-top:8px;">
                <strong>{{ item.name }}</strong>
                <table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:4px;">
                    <thead>
                        <tr>
                            <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Tarih</th>
                            <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Açıklama</th>
                            <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Yön</th>
                            <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in item.transactions %}
                            <tr>
                                <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{{ tx.timestamp|date:"d.m.Y H:i" }}</td>
                                <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{{ tx.description|default:"-" }}</td>
                                <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{% if tx.direction == 'IN' %}Gelir{% else %}Gider{% endif %}</td>
                                <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{% if tx.direction == 'OUT' %}-{% endif %}{{ tx.amount|money }} ₺</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4" style="padding:4px;text-align:center;border-bottom:1px solid #e5e7eb;">Hareket yok</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
    </div>

    {% for cp in cp_print_data %}
        <div id="cp-print-{{ cp.id }}" class="hidden">
            <h2>{{ cp.name }} - Cari Özet</h2>
            <table style="width:100%;border-collapse:collapse;font-size:13px;margin-top:6px;">
                <thead>
                    <tr>
                        <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px;">Cari</th>
                        <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px;">İletişim</th>
                        <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px;">Gelir</th>
                        <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px;">Gider</th>
                        <th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:6px;">Net</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding:6px;border-bottom:1px solid #e5e7eb;">{{ cp.name }}</td>
                        <td style="padding:6px;border-bottom:1px solid #e5e7eb;">{{ cp.contact|default:"-" }}</td>
                        <td style="padding:6px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ cp.incoming|money }} ₺</td>
                        <td style="padding:6px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ cp.outgoing|money }} ₺</td>
                        <td style="padding:6px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ cp.net|money }} ₺</td>
                    </tr>
                </tbody>
            </table>

            <h3 style="margin-top:12px;">Aylık Özet</h3>
            {% for entry in cp_monthly %}
                {% if entry.id == cp.id %}
                    <table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;">
                        <thead>
                            <tr>
                                <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Ay</th>
                                <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Gelir</th>
                                <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Gider</th>
                                <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Net</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in entry.months %}
                                <tr>
                                    <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{{ m.name }}</td>
                                    <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ m.incoming|money }} ₺</td>
                                    <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ m.outgoing|money }} ₺</td>
                                    <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{{ m.net|money }} ₺</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            {% endfor %}

            <h3 style="margin-top:12px;">İşlem Listesi (tarihli)</h3>
            {% for item in cp_tx_map %}
                {% if item.id == cp.id %}
                    <table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;">
                        <thead>
                            <tr>
                                <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Tarih</th>
                                <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Açıklama</th>
                                <th style="text-align:left;padding:4px;border-bottom:1px solid #e5e7eb;">Yön</th>
                                <th style="text-align:right;padding:4px;border-bottom:1px solid #e5e7eb;">Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in item.transactions %}
                                <tr>
                                    <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{{ tx.timestamp|date:"d.m.Y H:i" }}</td>
                                    <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{{ tx.description|default:"-" }}</td>
                                    <td style="padding:4px;border-bottom:1px solid #e5e7eb;">{% if tx.direction == 'IN' %}Gelir{% else %}Gider{% endif %}</td>
                                    <td style="padding:4px;text-align:right;border-bottom:1px solid #e5e7eb;">{% if tx.direction == 'OUT' %}-{% endif %}{{ tx.amount|money }} ₺</td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="4" style="padding:4px;text-align:center;border-bottom:1px solid #e5e7eb;">Hareket yok</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}

    <script>
        function selectAndPrint(id) {
            const select = document.getElementById('cp-print-select');
            if (select) {
                select.value = id;
            }
            printCounterparties();
        }
        (function autoSelectCp() {
            const cpSelect = document.getElementById('cp-select');
            if (cpSelect && cpSelect.options.length > 1) {
                // Varsayılan olarak ilk cari (boş hariç) seç
                cpSelect.selectedIndex = 1;
            }
        })();
        function printCounterparties() {
            const select = document.getElementById('cp-print-select');
            const orientationSelect = document.getElementById('cp-print-orientation');
            const target = select ? select.value : 'all';
            const areaId = target === 'all' ? 'cp-print-all' : `cp-print-${target}`;
            const area = document.getElementById(areaId);
            if (!area) return;
            const selectedText = select ? select.options[select.selectedIndex].text : 'Cari Özet';
            const title = target === 'all' ? 'Cari Özet' : `${selectedText} - Cari Özet`;
            const orientation = orientationSelect ? orientationSelect.value : 'portrait';
            const w = window.open('', '_blank', 'width=1000,height=1300');
            w.document.write(`<html><head><title>${title}</title>`);
            w.document.write(`<style>body{font-family:Manrope,Arial,sans-serif;padding:20px;font-size:13px;color:#0f172a;} h1,h2,h3,strong{margin:0 0 8px 0;} table{width:100%;border-collapse:collapse;margin-top:8px;} th,td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left;} th.text-right,td.text-right{text-align:right;} @page{size:A4 ${orientation};margin:10mm;}</style>`);
            w.document.write('</head><body>');
            w.document.write(`<h1 style="margin-bottom:12px;">${title}</h1>`);
            w.document.write(area.innerHTML);
            w.document.write('</body></html>');
            w.document.close();
            w.focus();
            w.print();
            w.close();
        }
    </script>
{% endblock %}
