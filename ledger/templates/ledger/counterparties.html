{% extends "ledger/base.html" %}
{% load money %}
{% block title %}Cariler{% endblock %}

{% block content %}
    <div class="space-y-4">
        <div class="glass rounded-xl p-5 border border-emerald-400/20 space-y-3">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <p class="text-sm text-slate-300">Yeni cari</p>
                    <h2 class="text-xl font-semibold">Cari oluştur</h2>
                </div>
                <span class="text-xs text-slate-400">Tüm alanları tek satırda doldurup kaydedin.</span>
            </div>
            <form method="post" class="grid md:grid-cols-2 gap-4 items-end">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_cari">
                <label class="block text-sm space-y-1">
                    <span>Ad</span>
                    <input name="name" required class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="Firma / kişi adı">
                </label>
                <label class="block text-sm space-y-1">
                    <span>İletişim</span>
                    <input name="contact" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="Telefon / e-posta">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Vergi No / T.C. No</span>
                    <input name="tax_id" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="Vergi kimlik no veya T.C. no">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Sorumlu / Ünvan</span>
                    <input name="contact_person" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="Muhasebe / yetkili kişi">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Adres</span>
                    <input name="address" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="Şirket adresi">
                </label>
                <label class="block text-sm space-y-1">
                    <span>IBAN</span>
                    <input name="iban" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="TR..">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Web sitesi</span>
                    <input name="website" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="https://">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Not</span>
                    <input name="notes" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2 h-11" placeholder="Kısa not">
                </label>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="px-5 py-2 rounded-lg bg-emerald-500 text-black font-semibold hover:bg-emerald-400 transition">Ekle</button>
                </div>
            </form>
            {% if message %}
                <div class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-sm" data-toast>{{ message }}</div>
            {% endif %}
            {% if error %}
                <div class="px-4 py-2 rounded-lg bg-rose-500/20 border border-rose-400/30 text-sm">{{ error }}</div>
            {% endif %}
        </div>

        <div class="glass rounded-xl p-5 border border-emerald-400/20 space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold">Cari özetleri</h2>
                <span class="text-xs text-slate-400">{{ summaries|length }} kayıt</span>
            </div>
            <div class="flex items-center gap-3 text-sm flex-wrap">
                <form method="get" class="flex items-center gap-2">
                    <select id="cp-quick-select" name="cp" class="rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" onchange="this.form.submit()">
                        <option value="">Cari seç</option>
                        {% for c in summaries %}
                            <option value="{{ c.id }}"
                                    {% if cp_filter == c.id %}selected{% endif %}
                                    data-name="{{ c.name|escapejs }}"
                                    data-contact="{{ c.contact|default:''|escapejs }}"
                                    data-tax="{{ c.tax_id|default:''|escapejs }}"
                                    data-address="{{ c.address|default:''|escapejs }}"
                                    data-iban="{{ c.iban|default:''|escapejs }}"
                                    data-person="{{ c.contact_person|default:''|escapejs }}"
                                    data-website="{{ c.website|default:''|escapejs }}"
                                    data-notes="{{ c.notes|default:''|escapejs }}"
                                    data-incoming="{{ c.incoming|default_if_none:0|money }}"
                                    data-outgoing="{{ c.outgoing|default_if_none:0|money }}"
                                    data-net="{{ c.net|default_if_none:0|money }}">
                                {{ c.name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="grid md:grid-cols-2 gap-3">
                {% for c in summaries %}
                    <div class="glass rounded-lg p-3 border border-white/10 flex flex-col gap-2">
                        <div class="flex items-start justify-between gap-2">
                            <button type="button"
                                    class="text-left font-semibold hover:text-emerald-300 transition cp-detail-btn"
                                    data-id="{{ c.id }}"
                                    data-name="{{ c.name|escapejs }}"
                                    data-contact="{{ c.contact|default:''|escapejs }}"
                                    data-tax="{{ c.tax_id|default:''|escapejs }}"
                                    data-address="{{ c.address|default:''|escapejs }}"
                                    data-iban="{{ c.iban|default:''|escapejs }}"
                                    data-person="{{ c.contact_person|default:''|escapejs }}"
                                    data-website="{{ c.website|default:''|escapejs }}"
                                    data-notes="{{ c.notes|default:''|escapejs }}"
                                    data-incoming="{{ c.incoming|default_if_none:0|money }}"
                                    data-outgoing="{{ c.outgoing|default_if_none:0|money }}"
                                    data-net="{{ c.net|default_if_none:0|money }}"
                                    data-edit-url="{% url 'counterparties' %}#edit-{{ c.id }}">
                                {{ c.name }}
                            </button>
                            <form method="post" onsubmit="return confirm('Bu cariyi silmek istiyor musun?');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete_cari">
                                <input type="hidden" name="counterparty_id" value="{{ c.id }}">
                                <button type="submit" class="px-2 py-1 rounded bg-rose-500/20 border border-rose-500/30 text-rose-100 text-xs hover:bg-rose-500/30">Sil</button>
                            </form>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 text-xs">
                            <span class="px-2 py-1 rounded-full bg-rose-500/10 border border-rose-500/20 text-rose-200">
                                Borç: {{ c.incoming|default_if_none:0|money }}
                            </span>
                            <span class="px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-200">
                                Ödenen: {{ c.outgoing|default_if_none:0|money }}
                            </span>
                            <span class="text-sm px-2 py-1 rounded-full bg-white/5 {% if c.net >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                                Kalan: {{ c.net|default_if_none:0|money }}
                            </span>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-slate-400">Cari eklenmedi.</p>
                {% endfor %}
            </div>

            <div id="cp-inline-detail" class="hidden glass rounded-xl p-4 border border-white/10 space-y-3 mt-3">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <div>
                        <p class="text-xs text-slate-400">Seçili cari</p>
            <h3 class="text-lg font-semibold">Cari için Borç / Ödeme</h3>
                    </div>
                    <div class="flex gap-2 text-sm">
                        <button type="button" id="inline-open-overlay" class="px-3 py-1 rounded bg-white/10 border border-white/15 hover:bg-white/15">Detay penceresi</button>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-3 text-sm text-slate-200">
                    <div><span class="text-slate-400 text-xs">İletişim</span><div id="inline-contact"></div></div>
                    <div><span class="text-slate-400 text-xs">Sorumlu</span><div id="inline-person"></div></div>
                    <div><span class="text-slate-400 text-xs">Vergi/T.C.</span><div id="inline-tax"></div></div>
                    <div><span class="text-slate-400 text-xs">IBAN</span><div id="inline-iban"></div></div>
                    <div class="md:col-span-2"><span class="text-slate-400 text-xs">Adres</span><div id="inline-address"></div></div>
                    <div class="md:col-span-2"><span class="text-slate-400 text-xs">Website</span><div id="inline-website"></div></div>
                </div>
                <div class="grid grid-cols-3 gap-3 text-sm text-slate-200">
                    <div class="glass rounded-lg p-3 border border-white/10">
                        <p class="text-xs text-slate-400">Borç</p>
                        <p id="inline-incoming" class="text-rose-300 font-semibold"></p>
                    </div>
                    <div class="glass rounded-lg p-3 border border-white/10">
                        <p class="text-xs text-slate-400">Ödenen</p>
                        <p id="inline-outgoing" class="text-emerald-300 font-semibold"></p>
                    </div>
                    <div class="glass rounded-lg p-3 border border-white/10">
                        <p class="text-xs text-slate-400">Kalan</p>
                        <p id="inline-net" class="font-semibold"></p>
                    </div>
                </div>
                <div>
                    <p class="text-xs text-slate-400">Not</p>
                    <p id="inline-notes" class="text-slate-200 text-sm"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="glass rounded-xl p-5 border border-emerald-400/20 space-y-4 mt-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Cari için Borç / Ödeme</h3>
            <span class="text-xs text-slate-400">Borç: kasa etkilenmez. Ödeme: seçtiğin kasa/bankadan düşer.</span>
        </div>
        <form method="post" class="space-y-3" id="cp-add-tx-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_tx">
            <div class="grid md:grid-cols-3 gap-3">
                <label class="block text-sm space-y-1 md:col-span-2">
                    <span>Cari</span>
                    <select id="cp-add-select" name="counterparty" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" required>
                        <option value="">Cari seç</option>
                        {% for c in counterparties %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="block text-sm space-y-1">
                    <span>İşlem</span>
                    <div class="flex gap-2">
                        <label class="flex items-center gap-1 px-2 py-2 rounded-lg bg-white/5 border border-white/10 text-xs">
                            <input type="radio" name="direction" value="IN" class="accent-emerald-500" checked>
                            <span>Borç</span>
                        </label>
                        <label class="flex items-center gap-1 px-2 py-2 rounded-lg bg-white/5 border border-white/10 text-xs">
                            <input type="radio" name="direction" value="OUT" class="accent-emerald-500">
                            <span>Ödeme</span>
                        </label>
                    </div>
                </label>
            </div>
            <div class="grid md:grid-cols-3 gap-3">
                <label class="block text-sm space-y-1">
                    <span>Tutar (TL)</span>
                    <input type="number" step="0.01" name="amount" required class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="0,00">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Kasa (Ödeme için)</span>
                    <select id="cp-add-account" name="account" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                        <option value="CASH">Nakit</option>
                        <option value="BANK">Banka</option>
                    </select>
                </label>
                <label class="block text-sm space-y-1 md:col-span-1">
                    <span>Açıklama</span>
                    <input type="text" name="description" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="İsteğe bağlı">
                </label>
            </div>
            <div class="text-xs text-slate-400">Borç seçildiğinde hesap NONE, ödeme seçildiğinde seçilen hesap kullanılır.</div>
            <button type="submit" class="px-5 py-2 rounded-lg bg-emerald-500 text-black font-semibold hover:bg-emerald-400 transition">Kaydet</button>
        </form>
    </div>

    <div id="cp-detail-overlay" class="hidden fixed inset-0 z-40 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center px-4">
        <div class="glass w-full max-w-2xl rounded-xl border border-white/10 shadow-2xl p-6 space-y-3">
            <div class="flex items-center justify-between gap-3 flex-wrap">
                <div>
                    <p class="text-xs text-slate-400">Cari detay</p>
                    <h3 id="cp-detail-name" class="text-xl font-semibold"></h3>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <button id="cp-detail-edit" type="button" class="px-3 py-1 rounded bg-white/10 border border-white/15 text-sm hover:bg-white/15">Düzenle</button>
                    <button id="cp-detail-close" class="px-3 py-1 rounded bg-white/10 border border-white/15 text-sm hover:bg-white/15">Kapat</button>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-3 text-sm text-slate-200">
                <div><span class="text-slate-400 text-xs">İletişim</span><div id="cp-detail-contact" class="font-semibold"></div></div>
                <div><span class="text-slate-400 text-xs">Sorumlu</span><div id="cp-detail-person"></div></div>
                <div><span class="text-slate-400 text-xs">Vergi/T.C.</span><div id="cp-detail-tax"></div></div>
                <div><span class="text-slate-400 text-xs">IBAN</span><div id="cp-detail-iban"></div></div>
                <div class="md:col-span-2"><span class="text-slate-400 text-xs">Adres</span><div id="cp-detail-address"></div></div>
                <div class="md:col-span-2"><span class="text-slate-400 text-xs">Website</span><div id="cp-detail-website"></div></div>
            </div>
            <div class="grid grid-cols-3 gap-3 text-sm text-slate-200">
                <div class="glass rounded-lg p-3 border border-white/10">
                    <p class="text-xs text-slate-400">Borç</p>
                    <p id="cp-detail-incoming" class="text-rose-300 font-semibold"></p>
                </div>
                <div class="glass rounded-lg p-3 border border-white/10">
                    <p class="text-xs text-slate-400">Ödenen</p>
                    <p id="cp-detail-outgoing" class="text-emerald-300 font-semibold"></p>
                </div>
                <div class="glass rounded-lg p-3 border border-white/10">
                    <p class="text-xs text-slate-400">Kalan</p>
                    <p id="cp-detail-net" class="font-semibold"></p>
                </div>
            </div>
            <div>
                <p class="text-xs text-slate-400">Not</p>
                <p id="cp-detail-notes" class="text-slate-200 text-sm"></p>
            </div>

            <div id="cp-edit-form" class="hidden border-t border-white/10 pt-3 mt-3">
                <form method="post" class="grid md:grid-cols-2 gap-3 text-sm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_cari">
                    <input type="hidden" name="counterparty_id" id="cp-edit-id">
                    <label class="space-y-1">
                        <span>Ad</span>
                        <input id="cp-edit-name" name="name" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <label class="space-y-1">
                        <span>İletişim</span>
                        <input id="cp-edit-contact" name="contact" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <label class="space-y-1">
                        <span>Sorumlu</span>
                        <input id="cp-edit-person" name="contact_person" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <label class="space-y-1">
                        <span>Vergi/T.C.</span>
                        <input id="cp-edit-tax" name="tax_id" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <label class="space-y-1">
                        <span>IBAN</span>
                        <input id="cp-edit-iban" name="iban" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <label class="space-y-1 md:col-span-2">
                        <span>Adres</span>
                        <input id="cp-edit-address" name="address" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <label class="space-y-1 md:col-span-2">
                        <span>Website</span>
                        <input id="cp-edit-website" name="website" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <label class="space-y-1 md:col-span-2">
                        <span>Not</span>
                        <textarea id="cp-edit-notes" name="notes" rows="3" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2"></textarea>
                    </label>
                    <label class="space-y-1 md:col-span-2">
                        <span>Log notu (isteğe bağlı)</span>
                        <input name="audit_note" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                    </label>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-500 text-black font-semibold hover:bg-emerald-400">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="cp-detail-overlay" class="hidden fixed inset-0 z-40 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center px-4">
        <div class="glass w-full max-w-2xl rounded-xl border border-white/10 shadow-2xl p-6 space-y-3">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-400">Cari detay</p>
                    <h3 id="cp-detail-name" class="text-xl font-semibold"></h3>
                </div>
                <button id="cp-detail-close" class="px-3 py-1 rounded bg-white/10 border border-white/15 text-sm hover:bg-white/15">Kapat</button>
            </div>
            <div class="grid md:grid-cols-2 gap-3 text-sm text-slate-200">
                <div><span class="text-slate-400 text-xs">İletişim</span><div id="cp-detail-contact" class="font-semibold"></div></div>
                <div><span class="text-slate-400 text-xs">Sorumlu</span><div id="cp-detail-person"></div></div>
                <div><span class="text-slate-400 text-xs">Vergi/T.C.</span><div id="cp-detail-tax"></div></div>
                <div><span class="text-slate-400 text-xs">IBAN</span><div id="cp-detail-iban"></div></div>
                <div class="md:col-span-2"><span class="text-slate-400 text-xs">Adres</span><div id="cp-detail-address"></div></div>
                <div class="md:col-span-2"><span class="text-slate-400 text-xs">Website</span><div id="cp-detail-website"></div></div>
            </div>
            <div class="grid grid-cols-3 gap-3 text-sm text-slate-200">
                <div class="glass rounded-lg p-3 border border-white/10">
                    <p class="text-xs text-slate-400">Gelir</p>
                    <p id="cp-detail-incoming" class="text-emerald-300 font-semibold"></p>
                </div>
                <div class="glass rounded-lg p-3 border border-white/10">
                    <p class="text-xs text-slate-400">Gider</p>
                    <p id="cp-detail-outgoing" class="text-rose-300 font-semibold"></p>
                </div>
                <div class="glass rounded-lg p-3 border border-white/10">
                    <p class="text-xs text-slate-400">Net</p>
                    <p id="cp-detail-net" class="font-semibold"></p>
                </div>
            </div>
            <div>
                <p class="text-xs text-slate-400">Not</p>
                <p id="cp-detail-notes" class="text-slate-200 text-sm"></p>
            </div>
        </div>
    </div>

    <script>
        function selectAndPrint(id) {
            const select = document.getElementById('cp-print-select');
            if (select) {
                select.value = id;
            }
            printCounterparties();
        }
        (function autoSelectCp() {
            const cpSelect = document.getElementById('cp-select');
            if (cpSelect && cpSelect.options.length > 1) {
                // Varsayılan olarak ilk cari (boş hariç) seç
                cpSelect.selectedIndex = 1;
            }
        })();
        function printCounterparties() {
            const select = document.getElementById('cp-print-select');
            const orientationSelect = document.getElementById('cp-print-orientation');
            const target = select ? select.value : 'all';
            const areaId = target === 'all' ? 'cp-print-all' : `cp-print-${target}`;
            const area = document.getElementById(areaId);
            if (!area) return;
            const selectedText = select ? select.options[select.selectedIndex].text : 'Cari Özet';
            const title = target === 'all' ? 'Cari Özet' : `${selectedText} - Cari Özet`;
            const orientation = orientationSelect ? orientationSelect.value : 'portrait';
            const w = window.open('', '_blank', 'width=1000,height=1300');
            w.document.write(`<html><head><title>${title}</title>`);
            w.document.write(`<style>body{font-family:Manrope,Arial,sans-serif;padding:20px;font-size:13px;color:#0f172a;} h1,h2,h3,strong{margin:0 0 8px 0;} table{width:100%;border-collapse:collapse;margin-top:8px;} th,td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left;} th.text-right,td.text-right{text-align:right;} @page{size:A4 ${orientation};margin:10mm;}</style>`);
            w.document.write('</head><body>');
            w.document.write(`<h1 style="margin-bottom:12px;">${title}</h1>`);
            w.document.write(area.innerHTML);
            w.document.write('</body></html>');
            w.document.close();
            w.focus();
            w.print();
            w.close();
        }

        // Cari detay aç/kapat
        (function attachCpDetailOverlay() {
            const overlay = document.getElementById('cp-detail-overlay');
            if (!overlay) return;
            const close = () => overlay.classList.add('hidden');
            overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
            const closeBtn = document.getElementById('cp-detail-close');
            if (closeBtn) closeBtn.addEventListener('click', close);
            const printBtn = document.getElementById('cp-detail-print');
            const editBtn = document.getElementById('cp-detail-edit');
            const editForm = document.getElementById('cp-edit-form');
            const inline = document.getElementById('cp-inline-detail');
            const inlineBtn = document.getElementById('inline-open-overlay');
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
            const setText = (scope, selector, val) => {
                const el = scope.querySelector(selector);
                if (el) el.textContent = val || '-';
            };
            const fillOverlay = (d) => {
                setText(overlay, '#cp-detail-name', d.name);
                setText(overlay, '#cp-detail-contact', d.contact);
                setText(overlay, '#cp-detail-person', d.person);
                setText(overlay, '#cp-detail-tax', d.tax);
                setText(overlay, '#cp-detail-iban', d.iban);
                setText(overlay, '#cp-detail-address', d.address);
                setText(overlay, '#cp-detail-website', d.website);
                setText(overlay, '#cp-detail-incoming', d.incoming);
                setText(overlay, '#cp-detail-outgoing', d.outgoing);
                const netVal = d.net || '0,00';
                setText(overlay, '#cp-detail-net', netVal);
                const netEl = overlay.querySelector('#cp-detail-net');
                if (netEl) netEl.className = (parseFloat((netVal || '0').replace(',', '.')) > 0 ? 'text-white' : 'text-rose-300') + ' font-semibold';
                setText(overlay, '#cp-detail-notes', d.notes);
                setVal('cp-edit-id', d.id);
                setVal('cp-edit-name', d.name);
                setVal('cp-edit-contact', d.contact);
                setVal('cp-edit-person', d.person);
                setVal('cp-edit-tax', d.tax);
                setVal('cp-edit-iban', d.iban);
                setVal('cp-edit-address', d.address);
                setVal('cp-edit-website', d.website);
                const notesField = document.getElementById('cp-edit-notes');
                if (notesField) notesField.value = d.notes ? d.notes.replace(/<br\\s*\\/?>/g, '\\n') : '';
                if (printBtn) {
                    printBtn.onclick = () => {
                        const title = d.name || 'Cari detay';
                        const w = window.open('', '_blank', 'width=900,height=1200');
                        w.document.write(`<html><head><title>${title}</title><style>body{font-family:Manrope,Arial,sans-serif;padding:20px;color:#0f172a;} .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-top:12px;} h2{margin:0 0 12px 0;} table{width:100%;border-collapse:collapse;margin-top:8px;} th,td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left;}</style></head><body>`);
                        w.document.write(`<h2>${title}</h2>`);
                        const content = overlay.querySelector('.glass') ? overlay.querySelector('.glass').innerHTML : overlay.innerHTML;
                        w.document.write(content);
                        w.document.write('</body></html>');
                        w.document.close();
                        w.focus();
                        w.print();
                        w.close();
                    };
                }
                if (editBtn && editForm) {
                    editForm.classList.add('hidden');
                    editBtn.onclick = () => {
                        editForm.classList.toggle('hidden');
                    };
                }
                overlay.classList.remove('hidden');
            };

            const fillInline = (d) => {
                if (!inline) return;
                inline.classList.remove('hidden');
                const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || '-'; };
                set('inline-name', d.name || '-');
                set('inline-contact', d.contact || '-');
                set('inline-person', d.person || '-');
                set('inline-tax', d.tax || '-');
                set('inline-iban', d.iban || '-');
                set('inline-address', d.address || '-');
                set('inline-website', d.website || '-');
                set('inline-incoming', d.incoming || '0,00');
                set('inline-outgoing', d.outgoing || '0,00');
                const netVal = d.net || '0,00';
                set('inline-net', netVal);
                const netEl = document.getElementById('inline-net');
                if (netEl) netEl.className = (parseFloat((netVal || '0').replace(',', '.')) > 0 ? 'text-white' : 'text-rose-300') + ' font-semibold';
                set('inline-notes', d.notes || '-');
                if (inlineBtn) inlineBtn.onclick = () => fillOverlay(d);
            };

            const handleOpen = (d) => {
                // dataset keyleri string; fallbackları boş stringe çekiyoruz
                const data = {
                    id: d.id || '',
                    name: d.name || '',
                    contact: d.contact || '',
                    person: d.person || '',
                    tax: d.tax || '',
                    iban: d.iban || '',
                    address: d.address || '',
                    website: d.website || '',
                    incoming: d.incoming || '0,00',
                    outgoing: d.outgoing || '0,00',
                    net: d.net || '0,00',
                    notes: d.notes || '',
                };
                fillInline(data);
                fillOverlay(data);
            };

            document.querySelectorAll('.cp-detail-btn').forEach((btn) => {
                btn.addEventListener('click', () => handleOpen(btn.dataset));
            });

            const quickSelect = document.getElementById('cp-quick-select');
            const quickOpen = document.getElementById('cp-quick-open');
            if (quickSelect && quickOpen) {
                const tryOpenSelected = () => {
                    const opt = quickSelect.options[quickSelect.selectedIndex];
                    if (!opt || !opt.value) return;
                    handleOpen(opt.dataset);
                };
                quickOpen.addEventListener('click', tryOpenSelected);
                // Açılır seçimde enter/çift tıklama desteği
                quickSelect.addEventListener('change', tryOpenSelected);
                quickSelect.addEventListener('dblclick', tryOpenSelected);
            }
        })();

        // Borç/Ödeme hızlı tuşları (kasa dışı/ kasa)
        (function attachCpAddForm() {
            const dirInputs = document.querySelectorAll('#cp-add-tx-form input[name="direction"]');
            const accSelect = document.getElementById('cp-add-account');
            const toggleAccount = () => {
                const dir = Array.from(dirInputs).find((i) => i.checked)?.value;
                if (!accSelect || !dir) return;
                accSelect.disabled = dir === 'IN';
                accSelect.classList.toggle('opacity-50', dir === 'IN');
            };
            dirInputs.forEach((input) => input.addEventListener('change', toggleAccount));
            toggleAccount();
        })();
    </script>
{% endblock %}
