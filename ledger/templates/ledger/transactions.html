{% extends "ledger/base.html" %}
{% load money l10n %}
{% block title %}Hareketler{% endblock %}

{% block content %}
    <div class="glass rounded-xl p-5 border border-purple-400/30 space-y-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
            <div>
                <p class="text-sm text-slate-300">Düzenleme ve log</p>
                <h2 class="text-2xl font-semibold">Hareketler</h2>
                <p class="text-xs text-slate-400">Yanlış kayıtları düzenleyebilir, işlem logunu görebilirsiniz.</p>
            </div>
            <div class="flex items-center gap-3 text-sm text-slate-300">
                <span>{% if show_all %}Tüm hareketler listeleniyor{% else %}Son 5 hareket listelenir{% endif %}</span>
                {% if show_all %}
                    <a href="{% url 'transactions_manage' %}" class="px-3 py-2 rounded bg-white/10 border border-white/15 text-xs hover:bg-white/15">Son 5'i göster</a>
                {% else %}
                    <a href="{% url 'transactions_manage' %}?show=all" class="px-3 py-2 rounded bg-white/10 border border-white/15 text-xs hover:bg-white/15">Tümünü göster</a>
                {% endif %}
            </div>
        </div>

        {% if message %}
            <div class="px-4 py-3 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-sm" data-toast>{{ message }}</div>
        {% endif %}
        {% if error %}
            <div class="px-4 py-3 rounded-lg bg-rose-500/20 border border-rose-400/30 text-sm" id="toast-error">{{ error }}</div>
        {% endif %}

        <div class="overflow-auto">
            <table class="min-w-full text-[13px] leading-tight">
                <thead class="text-slate-300 text-[12px] uppercase tracking-wide">
                    <tr>
                        <th class="text-left pb-2">Tarih</th>
                        <th class="text-left pb-2">Hesap</th>
                        <th class="text-left pb-2">Yön</th>
                        <th class="text-left pb-2">Cari</th>
                        <th class="text-left pb-2">Açıklama</th>
                        <th class="text-left pb-2">Tutar</th>
                        <th class="text-left pb-2">Düzenle</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for tx in transactions %}
                        <tr class="align-middle">
                            <form method="post" class="contents">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update">
                                <input type="hidden" name="transaction_id" value="{{ tx.id }}">
                                <td class="py-2 text-slate-300">
                                    <input type="datetime-local"
                                           name="timestamp"
                                           value="{{ tx.timestamp|date:'Y-m-d\\TH:i' }}"
                                           class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2 text-xs h-10">
                                </td>
                                <td class="py-2">
                                    <select name="account" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2 text-xs h-10">
                                        {% for code, label in tx.Account.choices %}
                                            <option value="{{ code }}" {% if tx.account == code %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="py-2">
                                    <select name="direction" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2 text-xs h-10">
                                        {% for code, label in tx.Direction.choices %}
                                            <option value="{{ code }}" {% if tx.direction == code %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="py-2">
                                    <select name="counterparty" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2 text-xs h-10">
                                        <option value="">Yok</option>
                                        {% for c in counterparties %}
                                            <option value="{{ c.id }}" {% if tx.counterparty and tx.counterparty.id == c.id %}selected{% endif %}>{{ c.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="py-2">
                                    <div class="flex gap-2">
                                        <input type="text" name="description" value="{{ tx.description }}" class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-2 text-xs h-10" placeholder="Açıklama">
                                        <input type="text" name="audit_note" placeholder="Log notu" class="w-28 bg-slate-800 border border-slate-700 rounded px-2 py-2 text-[11px] h-10">
                                    </div>
                                </td>
                                <td class="py-2">
                                    <input type="number"
                                           step="0.01"
                                           name="amount"
                                           value="{{ tx.amount|default_if_none:0|floatformat:'2'|unlocalize }}"
                                           data-amount="{{ tx.amount|default_if_none:0|floatformat:'2'|unlocalize }}"
                                           class="w-28 bg-slate-800 border border-slate-700 rounded px-2 py-2 text-right text-xs h-10">
                                </td>
                                <td class="py-2 whitespace-nowrap">
                                    <div class="flex gap-2">
                                        <button type="submit" name="action" value="update" class="w-16 h-10 rounded bg-purple-500 text-black font-semibold text-xs hover:bg-purple-400">Kaydet</button>
                                        <button type="submit" name="action" value="delete" class="w-12 h-10 rounded bg-rose-500 text-black font-semibold text-xs hover:bg-rose-400" data-confirm="Silmek istediğine emin misin?">Sil</button>
                                    </div>
                                </td>
                            </form>
                        </tr>
                    {% empty %}
                        <tr><td colspan="7" class="py-4 text-center text-slate-400">Hareket yok</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="glass rounded-xl p-5 border border-purple-400/30 space-y-3 mt-4">
        <div class="flex items-center justify-between flex-wrap gap-2">
            <div class="flex items-center gap-3">
                <h3 class="text-lg font-semibold">Düzenleme Logu</h3>
                <button id="toggle-log" class="px-3 py-1 rounded bg-white/10 text-xs border border-white/15">Göster/Gizle</button>
            </div>
            <span class="text-xs text-slate-400">{{ audits|length }} kayıt</span>
        </div>
        <div class="overflow-auto max-h-[55vh] rounded-lg border border-white/10 bg-slate-900/30" id="log-panel">
            <div class="grid grid-cols-[110px,140px,140px,120px,1fr,1fr,90px] text-[12px] text-slate-300 font-medium px-3 py-2 border-b border-white/5">
                <span>Zaman</span>
                <span>Hareket</span>
                <span>Kullanıcı / IP</span>
                <span>Not</span>
                <span>Önce</span>
                <span>Sonra</span>
                <span class="text-center">Geri al</span>
            </div>
            <div class="divide-y divide-white/5 text-[12px] leading-snug">
                {% for log in audits %}
                    <div class="grid grid-cols-[110px,140px,140px,120px,1fr,1fr,90px] px-3 py-2 items-center hover:bg-white/5">
                        <div class="text-slate-300 whitespace-nowrap">{{ log.changed_at|date:"d.m.Y H:i" }}</div>
                        <div>
                            <div class="font-semibold text-slate-100">{{ log.transaction.id }}</div>
                            <div class="text-slate-400 text-[11px]">{{ log.transaction.description|default:"(açıklama yok)" }}</div>
                        </div>
                        <div class="text-slate-300 text-[11px]">
                            {{ log.username|default:"anon" }}<br>
                            {{ log.ip_address|default:"-" }}
                        </div>
                        <div class="text-slate-300 text-[11px]">{{ log.note|default:"-" }}</div>
                        <div class="text-slate-200 text-[11px]">
                            <div class="font-semibold text-slate-100">
                                {% if log.old_account == 'CASH' %}Nakit{% elif log.old_account == 'BANK' %}Banka{% else %}{{ log.old_account }}{% endif %}
                                /
                                {% if log.old_direction == 'IN' %}Gelir{% elif log.old_direction == 'OUT' %}Gider{% else %}{{ log.old_direction }}{% endif %}
                            </div>
                            <div class="text-amber-200 font-semibold">Tutar: {{ log.old_amount|money }}</div>
                            <div class="text-slate-400">Açıklama: {{ log.old_description|default:"-" }}</div>
                            <div class="text-slate-500">Cari: {{ log.old_counterparty|default:"-" }}</div>
                        </div>
                        <div class="text-slate-200 text-[11px]">
                            <div class="font-semibold text-slate-100">
                                {% if log.new_account == 'CASH' %}Nakit{% elif log.new_account == 'BANK' %}Banka{% else %}{{ log.new_account }}{% endif %}
                                /
                                {% if log.new_direction == 'IN' %}Gelir{% elif log.new_direction == 'OUT' %}Gider{% else %}{{ log.new_direction }}{% endif %}
                            </div>
                            <div class="text-emerald-200 font-semibold">Tutar: {{ log.new_amount|money }}</div>
                            <div class="text-slate-400">Açıklama: {{ log.new_description|default:"-" }}</div>
                            <div class="text-slate-500">Cari: {{ log.new_counterparty|default:"-" }}</div>
                        </div>
                        <div class="flex justify-center">
                            <form method="post" class="contents">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="restore_audit">
                                <input type="hidden" name="audit_id" value="{{ log.id }}">
                                <button type="submit" class="px-3 py-1 rounded bg-emerald-500 text-black text-xs font-semibold hover:bg-emerald-400">Geri Al</button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <div class="px-4 py-3 text-center text-slate-400 text-sm">Log yok</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        ['toast-success', 'toast-error'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                setTimeout(() => el.classList.add('hidden'), 4000);
            }
        });
        const toggleLog = document.getElementById('toggle-log');
        const logPanel = document.getElementById('log-panel');
        if (toggleLog && logPanel) {
            toggleLog.addEventListener('click', () => {
                logPanel.classList.toggle('hidden');
            });
        }
        // Tutar alanı boş kalırsa mevcut tutarı doldur.
        document.querySelectorAll('input[name="amount"][data-amount]').forEach((el) => {
            if (!el.value) {
                el.value = el.getAttribute('data-amount') || '';
            }
        });
    </script>
{% endblock %}
