{% extends "ledger/base.html" %}
{% load money %}
{% block title %}Geçmiş İşlem{% endblock %}

{% block content %}
    <div class="glass rounded-xl p-5 border border-amber-400/20 space-y-4">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-slate-300">Geçmiş kayıt</p>
                <h2 class="text-2xl font-semibold">Tarihli İşlem Ekle</h2>
                <p class="text-xs text-slate-400">Ana mimariye kaydedilir, girdi/çıkış listelerinde görünür.</p>
            </div>
        </div>

        <form method="post" class="space-y-3" id="backdate-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_past">
            <div class="grid md:grid-cols-3 gap-3">
                <label class="block text-sm space-y-1">
                    <span>Tarih</span>
                    <input type="date" name="date" required class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Saat</span>
                    <input type="time" name="time" value="12:00" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                </label>
                <label class="block text-sm space-y-1">
                    <span>Tutar</span>
                    <input type="number" step="0.01" name="amount" required class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="0.00">
                </label>
            </div>
            <div class="grid md:grid-cols-3 gap-3">
                <label class="block text-sm space-y-1">
                    <span>İşlem</span>
                    <select name="direction" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                        {% for d in directions %}
                            <option value="{{ d.value }}">{{ d.label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="block text-sm space-y-1">
                    <span>Hesap</span>
                    <select name="account" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                        {% for a in accounts %}
                            <option value="{{ a.value }}">{{ a.label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="block text-sm space-y-1">
                    <span>Açıklama</span>
                    <input type="text" name="description" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Örn: tahsilat, ödeme">
                </label>
            </div>
            <div class="grid md:grid-cols-2 gap-3">
                <label class="block text-sm space-y-1">
                    <span>Mevcut cari</span>
                    <select name="counterparty" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2">
                        <option value="">Seçiniz (opsiyonel)</option>
                        {% for c in counterparties %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="block text-sm space-y-1">
                    <span>Yeni cari ekle</span>
                    <input type="text" name="new_counterparty" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Cari adı">
                </label>
            </div>
            <div class="flex items-center gap-3">
                <button type="submit" class="px-6 py-2 rounded-lg bg-amber-500 text-black font-semibold hover:bg-amber-400 transition">Kaydet</button>
                <button type="button" id="fill-last" class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-sm hover:bg-white/20">Son değerleri getir</button>
            </div>
        </form>

        {% if message %}
            <div class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-sm" data-toast>{{ message }}</div>
        {% endif %}
        {% if error %}
            <div class="px-4 py-2 rounded-lg bg-rose-500/20 border border-rose-400/30 text-sm">{{ error }}</div>
        {% endif %}
    </div>

    <div class="glass rounded-xl p-5 border border-emerald-400/20 space-y-4 mt-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Son 50 hareket</h3>
            <span class="text-xs text-slate-400">Tüm tarihler</span>
        </div>
        <div class="overflow-auto max-h-[60vh]">
            <table class="min-w-full text-sm">
                <thead class="text-slate-300">
                    <tr>
                        <th class="text-left pb-2">Tarih</th>
                        <th class="text-left pb-2">Hesap</th>
                        <th class="text-left pb-2">Açıklama</th>
                        <th class="text-left pb-2">Cari</th>
                        <th class="text-right pb-2">Tutar</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for tx in transactions %}
                        <tr>
                            <td class="py-2 text-slate-300 whitespace-nowrap">{{ tx.timestamp|date:"d.m.Y H:i" }}</td>
                            <td class="py-2 text-slate-300 whitespace-nowrap">{{ tx.get_account_display }} / {{ tx.get_direction_display }}</td>
                            <td class="py-2">{{ tx.description|default:"-" }}</td>
                            <td class="py-2 text-slate-300">{{ tx.counterparty|default:"-" }}</td>
                            <td class="py-2 text-right {% if tx.direction == 'IN' %}text-emerald-300{% else %}text-rose-300{% endif %}">
                                {% if tx.direction == 'OUT' %}-{% endif %}{{ tx.amount|money }} ₺
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="5" class="py-4 text-center text-slate-400">Kayıt yok</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        (function () {
            const form = document.getElementById('backdate-form');
            const fill = document.getElementById('fill-last');
            const key = 'backdate:last';
            if (form) {
                form.addEventListener('submit', () => {
                    const data = Object.fromEntries(new FormData(form));
                    localStorage.setItem(key, JSON.stringify(data));
                });
            }
            if (fill) {
                fill.addEventListener('click', () => {
                    const raw = localStorage.getItem(key);
                    if (!raw) return;
                    try {
                        const data = JSON.parse(raw);
                        ['date','time','amount','direction','account','description','counterparty','new_counterparty'].forEach((name) => {
                            if (form && data[name] !== undefined && form.elements[name]) {
                                form.elements[name].value = data[name];
                            }
                        });
                    } catch (e) {
                        console.warn('Veri okunamadı', e);
                    }
                });
            }
        })();
    </script>
{% endblock %}
